<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Law Review Comment Viewer - v11 (Fixed Delete)</title>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin:0; padding:0; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .content-control-highlight { background-color:#E3F2FD; }
        [contenteditable] { outline:none; }
        [contenteditable]:focus { background-color:#f9fafb; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
/** Entire file rewritten with fixed delete function **/
const { useState, useEffect, useMemo, useRef } = React;

function RichTextCell({ value, onChange, placeholder }) {
  const [showToolbar, setShowToolbar] = useState(false);
  const editorRef = useRef(null);
  const toolbarRef = useRef(null);

  const applyFormat = (cmd) => {
    document.execCommand(cmd, false, null);
    editorRef.current?.focus();
  };

  const handleInput = () => {
    if (editorRef.current) onChange(editorRef.current.innerHTML);
  };

  useEffect(() => {
    if (editorRef.current && editorRef.current.innerHTML !== value) {
      editorRef.current.innerHTML = value || '';
    }
  }, [value]);

  return (
    <div className="relative">
      {showToolbar && (
        <div ref={toolbarRef} className="absolute -top-10 left-0 bg-white border border-gray-300 rounded shadow-lg flex gap-1 p-1 z-50">
          <button onMouseDown={(e)=>{e.preventDefault();applyFormat('bold')}} className="px-2 py-1 border">B</button>
          <button onMouseDown={(e)=>{e.preventDefault();applyFormat('italic')}} className="px-2 py-1 border italic">I</button>
          <button onMouseDown={(e)=>{e.preventDefault();applyFormat('underline')}} className="px-2 py-1 border underline">U</button>
          <button onMouseDown={(e)=>{e.preventDefault();applyFormat('removeFormat')}} className="px-2 py-1 border text-red-600">✕</button>
        </div>
      )}
      <div
        ref={editorRef}
        contentEditable
        onFocus={() => setShowToolbar(true)}
        onBlur={(e) => {
          if (toolbarRef.current && toolbarRef.current.contains(e.relatedTarget)) return;
          setShowToolbar(false);
        }}
        onInput={handleInput}
        className="w-full min-h-[3rem] px-2 py-2 rounded"
        suppressContentEditableWarning
      />
      {!value && (
        <div className="absolute top-2 left-2 text-gray-400 select-none pointer-events-none">
          {placeholder}
        </div>
      )}
    </div>
  );
}

function CommentViewer() {
  const [comments, setComments] = useState([]);
  const [expandedComments, setExpanded] = useState(new Set());
  const [officeReady, setOfficeReady] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    Office.onReady((info) => {
      if (info.host === Office.HostType.Word) {
        setOfficeReady(true);
        loadCommentsFromWord();
      }
    });
  }, []);

  async function loadCommentsFromWord() {
    setLoading(true);
    try {
      await Word.run(async (context) => {
        const props = context.document.properties.customProperties;
        const prop = props.getItemOrNullObject("lawReviewComments");
        prop.load("value");
        await context.sync();
        if (!prop.isNullObject) setComments(JSON.parse(prop.value));
      });
    } finally { setLoading(false); }
  }

  function handleDeleteClick(id) {
    if (!confirm(`Delete comment ${id}?`)) return;
    performDelete(id);
  }

  /** FIXED DELETE FUNCTION **/
  async function performDelete(commentId) {
    try {
      // Update UI immediately
      const updated = comments.filter(c => c.id !== commentId);
      setComments(updated);

      await Word.run(async (context) => {
        const controls = context.document.contentControls;
        controls.load("items/tag");
        await context.sync();

        for (let cc of controls.items) {
          if (cc.tag === `lawreview-${commentId}`) {
            cc.delete(false);
            break;
          }
        }
        await context.sync();

        const props = context.document.properties.customProperties;
        const prop = props.getItemOrNullObject("lawReviewComments");
        await context.sync();
        if (!prop.isNullObject) {
          prop.value = JSON.stringify(updated);
        } else {
          props.add("lawReviewComments", JSON.stringify(updated));
        }
        await context.sync();

        alert("Comment deleted.");
      });
    } catch (err) {
      console.error(err);
      alert("Error deleting: " + err.message);
      loadCommentsFromWord();
    }
  }

  return (
    <div className="p-4">
      <h1 className="text-xl font-bold mb-4">Law Review Comments (Delete Fixed)</h1>
      {!officeReady && <div>Waiting for Word…</div>}
      {loading && <div>Loading…</div>}

      {comments.map(c => (
        <div key={c.id} className="border p-2 mb-2 rounded bg-white shadow">
          <div className="flex justify-between">
            <div className="font-bold">{c.id} — {c.location}</div>
            <button onClick={() => handleDeleteClick(c.id)} className="text-red-600">Delete</button>
          </div>
        </div>
      ))}
    </div>
  );
}

ReactDOM.render(<CommentViewer />, document.getElementById('root'));
</script>
</body>
</html>
